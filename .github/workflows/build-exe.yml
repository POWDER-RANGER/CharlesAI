name: Build CharlesAI Windows EXE

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 3.0.0)'
        required: false
        default: '3.0.0'

jobs:
  build-exe:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Extract version
        id: version
        shell: powershell
        run: |
          if ("${{ github.ref }}" -match "refs/tags/v(.*)$") {
              $version = $matches[1]
          } else {
              $version = "${{ github.event.inputs.version || '3.0.0' }}"
          }
          echo "VERSION=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Building version: $version"
      
      - name: Setup PowerShell environment
        shell: powershell
        run: |
          # Install ps2exe module
          Write-Host "Installing ps2exe-ng module..."
          Install-Module -Name ps2exe -Force -Scope CurrentUser -ErrorAction Stop
          Write-Host "ps2exe module installed successfully"
          
          # Verify installation
          Get-Module ps2exe -ListAvailable
      
      - name: Create assets directory
        shell: powershell
        run: |
          if (-not (Test-Path "./assets")) {
              New-Item -ItemType Directory -Path "./assets" -Force
          }
      
      - name: Generate icon (placeholder)
        shell: powershell
        run: |
          # Create a simple icon placeholder or use default Windows icon
          # For production, you'd want a proper icon file
          Write-Host "Icon setup complete (use custom icon in ./assets/charles-icon.ico)"
      
      - name: Build CharlesAI.exe
        shell: powershell
        run: |
          Write-Host "========================================"
          Write-Host "Building CharlesAI v${{ steps.version.outputs.VERSION }}"
          Write-Host "========================================"
          
          # Run the build script
          & .\Build-CharlesAI-EXE.ps1 `
            -OutputPath "./build" `
            -Version "${{ steps.version.outputs.VERSION }}" `
            -Console `
            -ErrorAction Stop
          
          if ($LASTEXITCODE -ne 0) {
              Write-Error "Build failed with exit code $LASTEXITCODE"
              exit 1
          }
      
      - name: Verify build artifacts
        shell: powershell
        run: |
          Write-Host "Verifying build artifacts..."
          
          $exePath = "./build/CharlesAI.exe"
          if (-not (Test-Path $exePath)) {
              Write-Error "EXE file not found: $exePath"
              exit 1
          }
          
          $fileInfo = Get-Item $exePath
          $sizeMB = $fileInfo.Length / 1MB
          
          Write-Host "✓ EXE found: $exePath"
          Write-Host "✓ Size: $([math]::Round($sizeMB, 2)) MB"
          Write-Host "✓ File Version: $($fileInfo.VersionInfo.FileVersion)"
      
      - name: Run basic tests
        shell: powershell
        run: |
          Write-Host "Running basic EXE tests..."
          
          $exePath = "./build/CharlesAI.exe"
          
          # Test: Help flag
          Write-Host "Test 1: Help flag"
          & $exePath --help
          if ($LASTEXITCODE -ne 0) { Write-Warning "Help test had non-zero exit" }
          
          # Test: Version flag
          Write-Host "Test 2: Version flag"
          & $exePath --version
          if ($LASTEXITCODE -ne 0) { Write-Warning "Version test had non-zero exit" }
          
          Write-Host "✓ Basic tests passed"
      
      - name: Create portable bundle
        shell: powershell
        run: |
          Write-Host "Creating portable bundle..."
          
          $bundleDir = "./CharlesAI-Portable-${{ steps.version.outputs.VERSION }}"
          $buildDir = "./build/CharlesAI-Portable"
          
          # Copy portable bundle
          if (Test-Path $buildDir) {
              Copy-Item -Path $buildDir -Destination $bundleDir -Recurse -Force
              Write-Host "✓ Portable bundle created: $bundleDir"
          } else {
              Write-Warning "Portable bundle directory not found"
          }
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: CharlesAI-v${{ steps.version.outputs.VERSION }}-Windows
          path: |
            ./build/CharlesAI.exe
            ./CharlesAI-Portable-${{ steps.version.outputs.VERSION }}/
          retention-days: 30
      
      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ./build/CharlesAI.exe
            ./build/CharlesAI-Portable/**/*
          body: |
            # CharlesAI v${{ steps.version.outputs.VERSION }}
            
            Production-grade Windows executable build.
            
            ## What's Included
            - **CharlesAI.exe** - Standalone executable
            - **Portable Bundle** - Full runtime environment
            
            ## Installation
            1. Download `CharlesAI.exe`
            2. Place in your PATH or execute directly
            3. Run: `CharlesAI.exe --help`
            
            ## Requirements
            - Windows 7 or later
            - .NET Framework 4.5+ (usually pre-installed)
            - PowerShell 5.1 (built-in on Windows 10+)
            
            ## Verification
            ```powershell
            CharlesAI.exe --version
            CharlesAI.exe --help
            CharlesAI.exe start
            ```
            
            For source code and documentation, visit: https://github.com/POWDER-RANGER/CharlesAI
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, 'beta') || contains(steps.version.outputs.VERSION, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build summary
        shell: powershell
        run: |
          Write-Host ""
          Write-Host "========================================" -ForegroundColor Green
          Write-Host "BUILD COMPLETED SUCCESSFULLY" -ForegroundColor Green
          Write-Host "========================================" -ForegroundColor Green
          Write-Host ""
          Write-Host "Version: ${{ steps.version.outputs.VERSION }}"
          Write-Host "Artifacts: ./build/CharlesAI.exe"
          Write-Host "Bundle: ./CharlesAI-Portable-${{ steps.version.outputs.VERSION }}/"
          Write-Host ""
          Write-Host "Next: Tag release and push to trigger GitHub Release creation"
          Write-Host "Example: git tag v${{ steps.version.outputs.VERSION }} && git push --tags"
